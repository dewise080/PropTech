{% load leaflet_tags %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Istanbul GIL PropTech - Mobile Map</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        primary: '#667eea', // Purple/Blue
                        secondary: '#2ecc71', // Green
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">

    <!-- Swiper CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />

    {% leaflet_css %}
    {% leaflet_js %}

    <style>
        /* Essential full-screen map setup */
        html, body { 
            height: 100%; 
            margin: 0; 
            overflow: hidden; /* Prevent body scroll */
            font-family: 'Inter', sans-serif;
        }
        #main_map { 
            height: 100vh; 
            width: 100vw; 
            transition: opacity 0.3s ease;
        }
        
        /* Custom Leaflet Marker Styling */
        .listing-photo-marker img {
            transition: all 0.2s ease;
        }
        .listing-photo-marker img:hover {
            filter: brightness(1.1) contrast(1.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }
        .leaflet-marker { transition: opacity 0.3s ease; }
        
        /* Bottom Sheet custom height/transform */
        .bottom-sheet {
            /* Full height but transformed down */
            transform: translateY(calc(100vh - 80px)); /* Visible handle/header */
            max-height: 100vh;
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            z-index: 1000;
        }

        .bottom-sheet.open-list {
            /* Open full screen for list view */
            transform: translateY(0);
        }

        .bottom-sheet.open-filter {
            /* Open partially for filter view (desktop filter panel replacement) */
            /* Adjusted for mobile screens to cover bottom half */
             transform: translateY(50vh); 
        }

        /* Range slider styling */
        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 6px;
            background: linear-gradient(to right, #667eea, #764ba2);
            border-radius: 3px;
            outline: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: white;
            border: 3px solid #667eea;
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        
        /* Swiper styles for listing popup carousel */
        .listing-swiper {
            width: 100%;
            height: 250px;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 12px;
        }
        
        .listing-swiper .swiper-slide {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f0f0f0;
        }
        
        .listing-swiper img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .swiper-pagination {
            position: relative !important;
            margin-top: 8px;
        }
        
        .swiper-pagination-bullet {
            background-color: #667eea !important;
            opacity: 0.6;
        }
        
        .swiper-pagination-bullet-active {
            opacity: 1 !important;
        }
        
        /* Animations for listing items */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes slideOut {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(-20px);
            }
        }
        
        .animate-slideIn {
            animation: slideIn 0.3s ease-out;
        }
        
        /* Hide the default Leaflet layer control on mobile to encourage filter usage */
        @media (max-width: 768px) {
            .leaflet-control-layers {
                display: none !important;
            }
        }
        
        /* Responsive improvements for small screens */
        @media (max-width: 640px) {
            #listingsList {
                padding: 0.5rem !important;
            }
            
            #listingsList > h2 {
                font-size: 1.25rem;
            }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Main Map Container -->
    {% leaflet_map "main_map" callback="window.initMap" %}

    <!-- MAP / LIST Toggle Button (Fixed on top of the map, below header) -->
    <div class="fixed top-4 left-1/2 -translate-x-1/2 z-[999] bg-white p-2 rounded-full shadow-lg border border-gray-200">
        <button id="viewToggle" class="flex items-center space-x-2 text-sm font-semibold text-primary px-3 py-1.5 rounded-full transition-all duration-200 hover:bg-indigo-50 active:scale-95">
            <span id="toggleIcon">üè†</span>
            <span id="toggleText">List View</span>
        </button>
    </div>

    <!-- Filter Drawer Button (Fixed on top right of the map) -->
    <button id="filterToggleBtn" class="fixed top-4 right-4 z-[999] bg-white p-2.5 rounded-full shadow-lg border border-gray-200 text-gray-700 transition-all duration-200 hover:bg-gray-100 active:scale-95 md:hidden">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 3.5l-10 10L5 10l-2 2 12 12 7-7 2-2-7-7zM7 21h10"/></svg>
    </button>
    
    <!-- DESKTOP Filter Panel (Hidden on mobile, replaces old fixed panel) -->
    <div id="desktopFilterPanel" class="hidden md:block fixed top-4 right-4 z-[999] bg-white p-4 rounded-xl shadow-2xl max-w-sm w-full max-h-[45vh] overflow-y-auto">
         <!-- Content will be mirrored from the Bottom Sheet -->
    </div>


    <!-- MOBILE Bottom Sheet / List View Container -->
    <div id="bottomSheet" class="bottom-sheet fixed inset-x-0 bottom-0 bg-white rounded-t-3xl shadow-2xl flex flex-col overflow-hidden">
        
        <!-- Header/Handle Bar -->
        <div id="sheetHandle" class="p-3 bg-white flex justify-center items-center cursor-pointer transition-colors duration-200 hover:bg-gray-50 rounded-t-3xl border-b border-gray-100">
             <div class="w-10 h-1 bg-gray-300 rounded-full"></div>
             <h3 id="sheetTitle" class="absolute left-4 text-lg font-bold text-gray-700">Filters & Controls</h3>
        </div>

        <!-- Content Area: List View & Filters/Controls -->
        <div id="sheetContent" class="flex-1 overflow-y-auto">
            
            <!-- 1. List View (Visible when in List Mode) -->
            <div id="listingsList" class="p-2 md:p-4 space-y-2 md:space-y-4 max-h-full overflow-y-auto" style="display: none;">
                <h2 class="text-xl md:text-2xl font-bold text-gray-800 border-b pb-2 sticky top-0 bg-white z-10">All Listings</h2>
                <!-- Dynamic list items will be inserted here -->
            </div>

            <!-- 2. Filters & Controls (Visible in Map Mode, or via Filter Toggle) -->
            <div id="filterControlContent" class="p-4 space-y-6">
                
                <!-- Radius Control (Adapted from original) -->
                <div class="bg-gray-50 p-4 rounded-xl shadow-inner">
                    <h3 class="text-base font-bold text-primary mb-3 flex items-center gap-2">üìç Search Radius</h3>
                    <input type="range" id="radiusSlider" min="100" max="5000" value="2000" step="100">
                    <div class="flex justify-between items-center mt-3 text-sm">
                        <span class="text-gray-600">Distance from Center</span>
                        <span class="radius-value text-lg font-bold text-primary" id="radiusValue">2.0 km</span>
                    </div>
                    <div class="listing-count bg-indigo-100 text-indigo-800 p-2 rounded-lg text-xs font-medium text-center mt-4" id="listingCount">Loading listings...</div>
                </div>


            </div>
        </div>
    </div>


    <script>
        // Global variables for map state and Firebase config
        let mapInstance;
        let listingsLayer;
        let transitLayer;
        let storesLayer;
        let closestStationsLayer; // Layer for closest metro stations per listing
        let radiusCircle;
        let mapCenter;
        let currentRadius = 2000;
        let isListView = false;
        let isFilterOpen = false;
        let storesData;
        
        // Structure to track store visibility (globalized for persistence)
        const storeVisibility = { byType: {}, byName: {} };
        let storesByType = {};

        // UI Elements
        const bottomSheet = document.getElementById('bottomSheet');
        const viewToggle = document.getElementById('viewToggle');
        const toggleIcon = document.getElementById('toggleIcon');
        const toggleText = document.getElementById('toggleText');
        const listingsList = document.getElementById('listingsList');
        const mapDiv = document.getElementById('main_map');
        const radiusSlider = document.getElementById('radiusSlider');
        const radiusValue = document.getElementById('radiusValue');
        const listingCount = document.getElementById('listingCount');
        const storeTypesContainer = document.getElementById('storeTypesContainer');
        const filterControlContent = document.getElementById('filterControlContent');
        const filterToggleBtn = document.getElementById('filterToggleBtn');
        const desktopFilterPanel = document.getElementById('desktopFilterPanel');
        
        // Mirror filter content to desktop panel
        desktopFilterPanel.innerHTML = filterControlContent.innerHTML;

        async function fetchJSON(url) {
            const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
            if (!res.ok) {
                console.error(`Failed to fetch ${url}:`, res.statusText);
                throw new Error('Failed to fetch ' + url);
            }
            return res.json();
        }

        // --- MAP SETUP AND INITIALIZATION ---
        window.initMap = async function(map, options) {
            mapInstance = map;
            
            // Set initial map center
            mapCenter = mapInstance.getCenter();

            // Load all data
            const [listingsData, transitData] = await Promise.all([
                fetchJSON('/api/listings.geojson'),
                fetchJSON('/api/transit.geojson'),
            ]);
            
            try {
                storesData = await fetchJSON('/api/stores.geojson');
            } catch (error) {
                console.warn('Failed to load stores data, using empty set.', error);
                storesData = { type: 'FeatureCollection', features: [] };
            }

            // 1. Listings Layer Setup
            listingsLayer = L.geoJSON(listingsData, {
                pointToLayer: (feature, latlng) => {
                    const imageUrl = feature.properties.image_url;
                    // ... (existing marker logic remains) ...
                    let photoHtml;
                    if (imageUrl) {
                        photoHtml = `
                            <div class="listing-photo-marker" style="
                                width: 48px;
                                height: 48px;
                                border-radius: 50%;
                                border: 3px solid white;
                                box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                                overflow: hidden;
                                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                cursor: pointer;
                            ">
                                <img src="${imageUrl}" style="
                                    width: 100%;
                                    height: 100%;
                                    object-fit: cover;
                                    border-radius: 47%;
                                " onerror="this.style.display='none'" />
                            </div>
                        `;
                    } else {
                        // Fallback SVG marker
                        photoHtml = `
                            <div class="listing-photo-marker" style="
                                width: 40px;
                                height: 40px;
                                border-radius: 50%;
                                border: 3px solid white;
                                box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                                background-color: #667eea;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                color: white;
                                font-size: 18px;
                                font-weight: bold;
                                cursor: pointer;
                            ">
                                üè†
                            </div>
                        `;
                    }
                    
                    const icon = L.divIcon({
                        html: photoHtml,
                        iconSize: imageUrl ? [48, 48] : [40, 40],
                        iconAnchor: imageUrl ? [24, 24] : [20, 20],
                        popupAnchor: [0, -24],
                        className: 'listing-photo-marker'
                    });
                    
                    return L.marker(latlng, { icon: icon });
                },
                onEachFeature: (feature, layer) => {
                    layer.bindPopup(listingPopup(feature.properties), { maxWidth: 300 });
                    layer.on('mouseover', function() { if (!isListView) this.openPopup(); });
                    layer.on('mouseout', function() { if (!isListView) this.closePopup(); });
                }
            }).addTo(mapInstance);

            // 2. Transit Layer Setup
            const metroIcon = L.icon({
                iconUrl: 'https://upload.wikimedia.org/wikipedia/commons/4/4f/Istanbul_Metro_Logo.svg',
                iconSize: [24, 24], iconAnchor: [12, 12], popupAnchor: [0, -12], className: 'metro-icon', crossOrigin: 'anonymous',
            });
            transitLayer = L.geoJSON(transitData, {
                pointToLayer: (f, latlng) => {
                    if (f.properties.mode === 'metro') return L.marker(latlng, { icon: metroIcon });
                    return L.circleMarker(latlng, { radius: 6, color: '#f59f00', fillColor: '#f59f00', fillOpacity: 0.9, });
                },
                onEachFeature: (feature, layer) => layer.bindPopup(`<strong>${feature.properties.name}</strong>`)
            });
            
            // 3. Stores Layer Setup
            storesLayer = L.geoJSON(storesData, {
                pointToLayer: (f, latlng) => {
                    const name = f.properties.name || 'Unknown Store';
                    const icon = getStoreIcon(name);
                    return L.marker(latlng, { icon: icon });
                },
                onEachFeature: (feature, layer) => {
                    const name = feature.properties.name || 'Unknown Store';
                    const type = feature.properties.store_type || 'store';
                    layer.bindPopup(`<strong>${name}</strong><br/><small>${type}</small>`, { maxWidth: 200 });
                }
            });

            // Initial view settings
            try {
                mapInstance.fitBounds(listingsLayer.getBounds(), { padding: [50, 50] });
            } catch (e) {
                mapInstance.setView([41.0082, 28.9784], 12); // Default to Istanbul center
            }

            // Layer Control (Standard Leaflet Control for Desktop only)
            const overlays = { 'Listings': listingsLayer, 'Public Transit': transitLayer, 'Stores': storesLayer };
            L.control.layers({}, overlays).addTo(mapInstance);
            
            // Initial radius circle
            radiusCircle = L.circle(mapCenter, currentRadius, {
                color: '#667eea',
                fill: true,
                fillColor: '#667eea',
                fillOpacity: 0.1,
                weight: 2,
                dashArray: '5, 5'
            }).addTo(mapInstance);

            // Setup UI logic
            initializeStoreVisibility();
            renderStoreFilterUI();
            updateLayerVisibility();
            updateRadiusFilter();
            setupEventListeners();
            renderListingsList();
        }

        // --- HELPER FUNCTIONS ---

        // Listing Popup HTML Generator
        function listingPopup(props) {
            const price = new Intl.NumberFormat('tr-TR').format(props.price);
            const size = props.size_sqm || 0;
            const dist = props.distance_to_station_m != null ? Math.round(props.distance_to_station_m) : '-';
            const station = props.closest_station_name || 'N/A';
            const groceryCount = props.grocery_stores_nearby || 0;
            const clothingCount = props.clothing_stores_nearby || 0;

            let priceClass;
            // Simple price tier logic for badge
            if (props.price < 500000) priceClass = 'bg-green-500';
            else if (props.price < 1500000) priceClass = 'bg-yellow-500';
            else priceClass = 'bg-red-500';

            // Build image carousel (max 3 images)
            let imageCarousel = '';
            const images = props.images || (props.image_url ? [props.image_url] : []);
            const imagesToShow = images.slice(0, 3); // Limit to 3 images
            
            if (imagesToShow.length > 0) {
                const swiperSlides = imagesToShow.map((img, idx) => 
                    `<div class="swiper-slide"><img src="${img}" alt="Listing image ${idx + 1}" onerror="this.src='/media/1.png'" /></div>`
                ).join('');
                
                imageCarousel = `
                    <div class="swiper listing-swiper" data-swiper-index="${Math.random()}">
                        <div class="swiper-wrapper">
                            ${swiperSlides}
                        </div>
                        ${imagesToShow.length > 1 ? '<div class="swiper-pagination"></div>' : ''}
                    </div>
                `;
            }

            return `
                <div class="font-sans" style="max-width: 100%; width: 320px;">
                    ${imageCarousel}
                    <div class="font-bold text-base text-gray-800">${props.title || 'Listing'}</div>
                    <div class="mt-2 flex items-center justify-between">
                        <span class="text-xl font-extrabold text-primary">${price} TL</span>
                        <span class="inline-block px-2 py-1 text-xs font-semibold rounded-full text-white ${priceClass}">${size} m¬≤</span>
                    </div>
                    <hr class="my-2 border-gray-200" />
                    <div class="text-sm space-y-1">
                        <div class="flex items-center">
                            <span class="font-semibold text-gray-600 w-20">Transit:</span> 
                            <span class="text-sm">${dist}m to ${station}</span>
                        </div>
                        <div class="flex items-center">
                            <span class="font-semibold text-gray-600 w-20">Amenities:</span> 
                            <span class="text-sm">üõí ${groceryCount}, üëï ${clothingCount}</span>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Store Icon Generator using static logo files
        function getStoreIcon(name) {
            // Map store names to their logo files
            const storeLogos = {
                'migros': '/static/store_icons/migros.png',
                'migros jet': '/static/store_icons/migros_jet.png',
                'm migros': '/static/store_icons/m_migros.png',
                'mm migros': '/static/store_icons/mm_migros.png',
                'bim': '/static/store_icons/bim.png',
                'a101': '/static/store_icons/a101.png',
                'carrefoursa': '/static/store_icons/carrefoursa.png',
                'carrefoursa gurme': '/static/store_icons/carrefoursa_gurme.png',
                'carrefoursa sper': '/static/store_icons/carrefoursa_sper.png',
                'onur': '/static/store_icons/onur.png',
                'onur market': '/static/store_icons/onur_market.png',
                'onur group': '/static/store_icons/onur_group.png',
                'onur gda': '/static/store_icons/onur_gda.png',
                'mavi': '/static/store_icons/mavi.png',
                '≈üok': '/static/store_icons/200px-≈ûOK_Market_logo.svg.png',
            };

            // Find matching logo (case-insensitive)
            const nameLower = name.toLowerCase();
            let logoUrl = null;
            
            for (const [key, url] of Object.entries(storeLogos)) {
                if (nameLower.includes(key)) {
                    logoUrl = url;
                    break;
                }
            }

            // Build icon HTML with logo or fallback emoji
            const iconHtml = logoUrl 
                ? `<img src="${logoUrl}" style="
                    width: 20px; 
                    height: 20px; 
                    border-radius: 50%; 
                    border: 1px solid #999;
                    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
                    object-fit: cover;
                " alt="${name}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />`
                : '';
            
            const fallbackHtml = `<div style="
                background: white; 
                border-radius: 50%; 
                width: 20px; height: 20px; 
                display: flex; 
                align-items: center; 
                justify-content: center; 
                font-size: 10px; 
                border: 1px solid #aaa;
                box-shadow: 0 1px 3px rgba(0,0,0,0.2);
                ${logoUrl ? 'display: none;' : ''}
            ">üõí</div>`;
            
            return L.divIcon({
                html: `<div style="display: flex; align-items: center; justify-content: center;">${iconHtml}${fallbackHtml}</div>`,
                iconSize: [20, 20],
                iconAnchor: [10, 10],
                popupAnchor: [0, -10],
                className: 'store-icon-marker',
            });
        }

        // --- FILTERING LOGIC ---
        
        // Initialize store visibility structure
        function initializeStoreVisibility() {
          storesData.features.forEach(feature => {
            const storeType = feature.properties.store_type;
            const storeName = feature.properties.name;
            
            if (!storesByType[storeType]) {
              storesByType[storeType] = new Set();
              storeVisibility.byType[storeType] = true;
            }
            storesByType[storeType].add(storeName);
            if (storeVisibility.byName[storeName] === undefined) {
                 storeVisibility.byName[storeName] = true;
            }
          });
        }
        
        // Toggle entire store type visibility
        window.toggleStoreType = function(storeType) {
          storeVisibility.byType[storeType] = !storeVisibility.byType[storeType];
          
          const storeNames = Array.from(storesByType[storeType]);
          storeNames.forEach(name => {
            storeVisibility.byName[name] = storeVisibility.byType[storeType];
          });
          
          updateStoreLayerVisibility();
          renderStoreFilterUI(); // Re-render to update checkboxes
        }
        
        // Toggle individual store name visibility
        window.toggleStoreName = function(storeName) {
          storeVisibility.byName[storeName] = !storeVisibility.byName[storeName];
          updateStoreLayerVisibility();
          renderStoreFilterUI(); // Re-render to update checkboxes
        }
        
        // Render the store filter UI
        function renderStoreFilterUI() {
          const containers = [
            document.getElementById('storeTypesContainer'), 
            desktopFilterPanel.querySelector('#storeTypesContainer')
          ].filter(Boolean); // Ensure both exist

          containers.forEach(container => {
            container.innerHTML = '';
            
            Object.keys(storesByType).sort().forEach(storeType => {
              const storeNames = Array.from(storesByType[storeType]).sort();
              const isTypeVisible = storeVisibility.byType[storeType];
              
              let namesListHtml = '';
              storeNames.forEach(storeName => {
                const isChecked = storeVisibility.byName[storeName];
                const typeId = storeType.replace(/\s/g, '-');
                const nameId = storeName.replace(/\s/g, '-');
                const checkboxId = `store-${typeId}-${nameId}-${container.id === 'storeTypesContainer' ? 'mobile' : 'desktop'}`;

                namesListHtml += `
                  <div class="flex items-center gap-2 text-sm p-1 hover:bg-gray-100 rounded">
                    <input type="checkbox" id="${checkboxId}" ${isChecked ? 'checked' : ''} onchange="window.toggleStoreName('${storeName}')" class="h-4 w-4 text-primary rounded border-gray-300 focus:ring-primary">
                    <label for="${checkboxId}" class="flex-1 cursor-pointer text-gray-700">${storeName}</label>
                  </div>
                `;
              });

              container.innerHTML += `
                <div class="border-b pb-3 mb-3">
                  <div class="flex items-center gap-2 cursor-pointer p-2 -mx-2 hover:bg-gray-100 rounded transition-colors" onclick="window.toggleStoreType('${storeType}')">
                    <div class="text-primary font-bold">${isTypeVisible ? '‚ñº' : '‚ñ∂'}</div>
                    <div class="flex-1 font-semibold text-gray-700">${storeType.charAt(0).toUpperCase() + storeType.slice(1)}</div>
                    <div class="text-xs bg-gray-200 px-2 py-0.5 rounded-full">${storeNames.length}</div>
                  </div>
                  <div class="ml-4 pt-2 space-y-1 ${isTypeVisible ? '' : 'hidden'}">
                    ${namesListHtml}
                  </div>
                </div>
              `;
            });
          });
        }

        // Update actual marker visibility based on state
        function updateStoreLayerVisibility() {
            if (mapInstance && mapInstance.hasLayer(storesLayer)) {
                storesLayer.eachLayer(function(layer) {
                    const storeName = layer.feature.properties.name;
                    const storeType = layer.feature.properties.store_type;
                    
                    const isTypeVisible = storeVisibility.byType[storeType] === true;
                    const isNameVisible = storeVisibility.byName[storeName] === true;
                    
                    if (isTypeVisible && isNameVisible) {
                        layer.setOpacity(1);
                    } else {
                        layer.setOpacity(0);
                    }
                });
            }
        }
        
        // Filter and display all markers within radius (listings, transit, stores)
        function updateRadiusFilter() {
          if (!mapInstance) return;

          let visibleListings = 0;
          let visibleTransit = 0;
          let visibleStores = 0;
          
          // Helper for distance calculation (Haversine)
          function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
          }
          
          const filterMarker = (layer, center) => {
            const latlng = layer.getLatLng();
            const distance = getDistance(center.lat, center.lng, latlng.lat, latlng.lng);
            
            if (distance <= currentRadius) {
              layer.setOpacity(1);
              return true;
            } else {
              layer.setOpacity(0.1);
              return false;
            }
          };

          // Filter layers
          listingsLayer.eachLayer(layer => { if (filterMarker(layer, mapCenter)) visibleListings++; });
          transitLayer.eachLayer(layer => { 
            if (mapInstance.hasLayer(transitLayer)) {
                if (filterMarker(layer, mapCenter)) visibleTransit++; 
            } else {
                // If transit layer is globally off, don't count it, but ensure opacity is 0
                layer.setOpacity(0);
            }
          });
          
          if (mapInstance.hasLayer(storesLayer)) {
            storesLayer.eachLayer(layer => {
              // Only count if within radius AND filter controls allow it
              const storeName = layer.feature.properties.name;
              if (storeVisibility.byName[storeName] && filterMarker(layer, mapCenter)) {
                visibleStores++;
                layer.setOpacity(1); // Ensure it's 1 if both radius and filter allow
              } else {
                layer.setOpacity(0.1);
              }
            });
          }

          listingCount.textContent = `${visibleListings} Listings | ${visibleTransit} Transit | ${visibleStores} Stores visible`;
          renderListingsList(); // Update the list view content
        }

        // Zoom-based layer filtering (Hides transit when zoomed out)
        function updateLayerVisibility() {
          if (!mapInstance || !transitLayer) return;

          const zoomLevel = mapInstance.getZoom();
          const transitEnabled = zoomLevel >= 12;
          
          if (transitEnabled) {
            if (!mapInstance.hasLayer(transitLayer)) mapInstance.addLayer(transitLayer);
          } else {
            if (mapInstance.hasLayer(transitLayer)) mapInstance.removeLayer(transitLayer);
          }
          
          // Re-apply radius filter when layer visibility changes
          updateRadiusFilter();
        }

        // --- LIST VIEW LOGIC ---

        // Generates the content for the mobile list view
        function renderListingsList() {
            if (!listingsLayer) return;

            const fragment = document.createDocumentFragment();
            const visibleListings = [];

            listingsLayer.eachLayer(layer => {
                // Only add markers that are currently visible (opacity > 0.5)
                if (mapInstance.hasLayer(listingsLayer) && layer.options.opacity > 0.5) {
                    visibleListings.push(layer.feature);
                }
            });
            
            // Sort by distance (assuming distance property is available on feature.properties)
            visibleListings.sort((a, b) => (a.properties.distance_to_center || 0) - (b.properties.distance_to_center || 0));

            visibleListings.forEach(feature => {
                const props = feature.properties;
                const price = new Intl.NumberFormat('tr-TR').format(props.price);
                const size = props.size_sqm || 0;
                const dist = props.distance_to_station_m != null ? Math.round(props.distance_to_station_m) : '-';
                
                const listItem = document.createElement('div');
                listItem.className = 'bg-white p-3 md:p-4 rounded-lg md:rounded-xl shadow-md hover:shadow-lg flex gap-3 md:gap-4 cursor-pointer hover:bg-gray-50 transition-all transform hover:scale-102 animate-slideIn relative group';
                listItem.style.animation = 'slideIn 0.3s ease-out';
                
                listItem.innerHTML = `
                    <div class="w-16 h-16 md:w-20 md:h-20 flex-shrink-0 bg-gray-200 rounded-lg overflow-hidden border border-gray-300">
                        <img src="${props.image_url || 'https://placehold.co/80x80/667eea/ffffff?text=üè†'}" 
                             alt="Listing Photo" class="w-full h-full object-cover" 
                             onerror="this.src='https://placehold.co/80x80/667eea/ffffff?text=üè†'">
                    </div>
                    <div class="flex-1 min-w-0">
                        <h4 class="text-base md:text-lg font-bold text-gray-800 truncate">${props.title || 'Property Listing'}</h4>
                        <div class="text-primary font-extrabold text-lg md:text-xl mt-0.5">${price} TL</div>
                        <div class="flex items-center text-xs md:text-sm text-gray-500 mt-1 space-x-2 md:space-x-3">
                            <span>${size} m¬≤</span>
                            <span class="text-xs text-indigo-500">‚Ä¢</span>
                            <span class="truncate">üöá ${dist}m</span>
                        </div>
                    </div>
                    <button class="absolute top-2 right-2 md:top-3 md:right-3 w-6 h-6 md:w-7 md:h-7 bg-red-500 hover:bg-red-600 text-white rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-200 flex-shrink-0 z-20" 
                            onclick="event.stopPropagation(); this.closest('div').style.animation = 'slideOut 0.3s ease-in forwards'; setTimeout(() => this.closest('div').remove(), 300);">
                        ‚úï
                    </button>
                `;
                
                // Click to view on map
                listItem.onclick = () => {
                    // Find the corresponding marker and pan to it when clicked
                    listingsLayer.eachLayer(layer => {
                        if (layer.feature.properties.id === props.id) {
                            mapInstance.setView(layer.getLatLng(), 16);
                            layer.openPopup();
                            toggleView(false); // Switch back to map view
                        }
                    });
                };
                fragment.appendChild(listItem);
            });

            listingsList.innerHTML = '';
            if (visibleListings.length === 0) {
                listingsList.innerHTML = '<p class="text-center text-gray-500 pt-10">No listings found in the current radius or filter settings.</p>';
            } else {
                listingsList.appendChild(fragment);
            }
        }

        // --- UI EVENT HANDLERS ---
        
        // Toggle Map/List View State
        function toggleView(forceMap) {
            isListView = forceMap !== undefined ? !forceMap : !isListView;
            
            if (isListView) {
                // Switch to List View
                bottomSheet.classList.remove('open-filter');
                bottomSheet.classList.add('open-list');
                mapDiv.style.opacity = '0.1'; // Fade map into background
                listingsList.style.display = 'block';
                filterControlContent.style.display = 'none';
                toggleIcon.textContent = 'üó∫Ô∏è';
                toggleText.textContent = 'Map View';
                isFilterOpen = false;
                filterToggleBtn.style.display = 'none'; // Hide filter button in list view

            } else {
                // Switch to Map View
                bottomSheet.classList.remove('open-list', 'open-filter');
                mapDiv.style.opacity = '1'; // Show map
                listingsList.style.display = 'none';
                filterControlContent.style.display = 'block';
                toggleIcon.textContent = 'üè†';
                toggleText.textContent = 'List View';
                filterToggleBtn.style.display = 'flex'; // Show filter button in map view (mobile)
                
                // Close any open popups when switching back to map view
                mapInstance.closePopup();
            }
        }
        
        // Toggle Filter Controls on Mobile
        function toggleFilterDrawer() {
             // Only run this function on mobile screens
            if (window.innerWidth >= 768) return;

            isFilterOpen = !isFilterOpen;
            
            if (isFilterOpen) {
                bottomSheet.classList.add('open-filter');
                bottomSheet.classList.remove('open-list');
            } else {
                bottomSheet.classList.remove('open-filter');
            }
        }

        function setupEventListeners() {
            viewToggle.addEventListener('click', () => toggleView());
            filterToggleBtn.addEventListener('click', toggleFilterDrawer);
            
            // Desktop: Mirror filter content & toggle for the mobile button
            desktopFilterPanel.querySelector('#radiusSlider').addEventListener('input', (e) => {
                 radiusSlider.value = e.target.value;
                 radiusSlider.dispatchEvent(new Event('input'));
            });
            
            // Radius Slider Events
            radiusSlider.addEventListener('input', function() {
                currentRadius = parseFloat(this.value);
                const radiusKm = (currentRadius / 1000).toFixed(1);
                radiusValue.textContent = radiusKm + ' km';
                radiusCircle.setRadius(currentRadius);
                updateRadiusFilter();
            });

            // Map Events
            mapInstance.on('dragend', function() {
                mapCenter = mapInstance.getCenter();
                radiusCircle.setLatLng(mapCenter);
                updateRadiusFilter();
            });
            
            mapInstance.on('zoomend', updateLayerVisibility);

            // Layer control visibility handling
            mapInstance.on('layeradd', function(e) {
                if (e.layer === storesLayer) updateStoreLayerVisibility();
                updateRadiusFilter(); // Re-evaluate layer visibility
            });

            mapInstance.on('layerremove', function(e) {
                if (e.layer === storesLayer) {
                    storesLayer.eachLayer(layer => layer.setOpacity(0));
                }
                updateRadiusFilter();
            });
        }

        // Initialize Swiper carousels for popups
        function initializePopupSwiper() {
            setTimeout(() => {
                const swipers = document.querySelectorAll('.listing-swiper');
                swipers.forEach(swiperEl => {
                    // Check if already initialized
                    if (!swiperEl.swiper) {
                        new Swiper(swiperEl, {
                            loop: swipers.length > 1,
                            pagination: {
                                el: swiperEl.querySelector('.swiper-pagination'),
                                clickable: true,
                                dynamicBullets: true
                            },
                            navigation: false,
                            autoplay: false,
                            effect: 'slide'
                        });
                    }
                });
            }, 100);
        }

        // Hook into Leaflet popup events to initialize Swiper when popup opens
        mapInstance.on('popupopen', function() {
            initializePopupSwiper();
        });
    </script>
    <!-- Swiper JS -->
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
</body>
</html>